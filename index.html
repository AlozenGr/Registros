<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRANTOP ‚Äì Controle de Trabalho & Despesas</title>
  <link rel="icon" href="data:," />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Padr√£o do modelo: API_URL via config.js -->
  <script src="config.js"></script>
  <style>
    .card{border:1px solid #e2e8f0;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .badge{border-radius:9999px;padding:2px 8px;font-size:12px;font-weight:600;display:inline-block}
    .badge-green{background:#dcfce7;color:#166534}.badge-red{background:#fee2e2;color:#991b1b}
    .badge-blue{background:#dbeafe;color:#1e40af}.badge-slate{background:#e2e8f0;color:#334155}
  </style>
  <script>
    const API_URL = (window.GRANTOP_CONFIG && window.GRANTOP_CONFIG.API_URL) || 'https://script.google.com/macros/s/AKfycbxqmLLygOg9Di8eTPy0zxbyxKa4PwqCzedzQN1HautErAC8MiaqIRq4FpO4xwP0MFjFVQ/exec';
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="p-4 bg-white shadow flex items-center justify-between">
    <h1 class="text-lg md:text-xl font-bold">üìä Controle Mensal ‚Äì GRANTOP</h1>
    <a href="#" id="btnReload" class="text-sm text-blue-700 hover:underline">Atualizar</a>
  </header>

  <main class="p-4 space-y-6">

    <!-- FORM -->
    <section class="card p-4">
      <h2 class="font-semibold mb-3">Adicionar Registro</h2>
      <form id="newForm" class="grid md:grid-cols-6 gap-3">
        <input id="inData" class="border rounded px-3 py-2" name="data" type="date" required />
        <input id="inCliente" class="border rounded px-3 py-2" name="cliente" placeholder="Cliente" />
        <input id="inEndereco" class="border rounded px-3 py-2 md:col-span-2" name="endereco" placeholder="Endere√ßo" />
        <select id="inPago" class="border rounded px-3 py-2" name="pago">
          <option value="N√£o">Pago? N√£o</option>
          <option value="Sim">Pago? Sim</option>
        </select>
        <input id="inValor" class="border rounded px-3 py-2" name="valor" type="text" inputmode="decimal" placeholder="Valor da despesa" />
        <button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 md:col-span-6" type="submit">Salvar</button>
      </form>
      <p class="text-xs text-slate-500 mt-2">Obs.: ‚ÄúDias trabalhados‚Äù contam datas √∫nicas com tipo ‚ÄúTRABALHO‚Äù.</p>
    </section>

    <!-- RESUMO -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Resumo Mensal</h2>
        <label class="text-sm">Janela:
          <select id="windowSel" class="border rounded px-2 py-1">
            <option value="1">1 m√™s</option>
            <option value="2">2 meses</option>
            <option value="3">3 meses</option>
            <option value="4">4 meses</option>
            <option value="5">5 meses</option>
            <option value="6" selected>6 meses</option>
            <option value="12">12 meses</option>
          </select>
        </label>
      </div>
      <div id="summary" class="grid md:grid-cols-3 gap-3"></div>
    </section>

    <!-- M√äS -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Registros do m√™s</h2>
        <div class="text-sm">Selecionado: <b id="monthLabel"></b></div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-4">
        <div class="p-3 rounded-xl border bg-white">
          <div class="font-semibold mb-1">Dias trabalhados (lista)</div>
          <ul id="diasLista" class="list-disc pl-5 text-sm space-y-1"></ul>
          <div id="diasEmpty" class="text-xs text-slate-500 hidden">N√£o h√° dias trabalhados registrados para este m√™s.</div>
        </div>
        <div class="p-3 rounded-xl border bg-white">
          <div class="font-semibold mb-1">Total de despesas no m√™s</div>
          <div id="despesasTotalMes" class="text-lg font-bold">R$ 0,00</div>
        </div>
        <div class="p-3 rounded-xl border bg-white">
          <div class="font-semibold mb-1">Somat√≥ria do m√™s</div>
          <div class="text-sm">
            Dias trabalhados: <b id="diasCount">0</b><br/>
            Despesas: <b id="despesasCount">R$ 0,00</b>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border rounded-lg overflow-hidden">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2 border">Data</th>
              <th class="text-left p-2 border">Cliente</th>
              <th class="text-left p-2 border">Endere√ßo</th>
              <th class="text-left p-2 border">Pago</th>
              <th class="text-left p-2 border">Tipo</th>
              <th class="text-right p-2 border">Valor</th>
            </tr>
          </thead>
          <tbody id="tbodyMes"></tbody>
        </table>
        <div id="tblEmpty" class="text-xs text-slate-500 mt-2 hidden">N√£o h√° registros para este m√™s.</div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Utils ===== */
    const moneyBR = v => Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    const toNumberBR = v => !v ? 0 : Number(String(v).replace(/\\./g,'').replace(',', '.')) || 0;
    const yyyymm = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');

    function normalizeISO(dateLike){
      if (!dateLike) return '';
      if (/^\\d{4}-\\d{2}-\\d{2}$/.test(String(dateLike))) return String(dateLike);
      const d = new Date(String(dateLike));
      if (isNaN(d)) return '';
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }
    function fmtDDMMYYYY(iso){
      const s = normalizeISO(iso);
      if (!s) return '';
      const [Y,M,D] = s.split('-');
      return `${D}/${M}/${Y}`;
    }

    /* ===== API ===== */
    const apiGet = async (params='')=>{
      const r = await fetch(API_URL + (params?`?${params}`:''));
      const j = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error('GET '+r.status);
      return j;
    };

    // POST text/plain (padr√£o do modelo) ‚Äî simple request
    const apiAdd = async (payload)=>{
      const r = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ action:'add', payload })
      });
      const txt = await r.text(); // parse resiliente
      let j = {}; try { j = JSON.parse(txt); } catch(_) {}
      if (!r.ok || !j.ok) throw new Error((j && j.error) || ('POST '+r.status));
      return j;
    };

    /* ===== Render ===== */
    function renderSummary(summary){
      const div = document.getElementById('summary');
      div.innerHTML = '';
      Object.keys(summary).sort().forEach(m=>{
        const d = summary[m] || {diasTrabalhados:0, despesasTotal:0};
        const el = document.createElement('div');
        el.className = 'p-3 rounded-xl border shadow text-sm bg-white';
        el.innerHTML = `
          <div class="font-semibold">${m}</div>
          <div>Dias trabalhados: <b>${d.diasTrabalhados}</b></div>
          <div>Despesas: R$ <b>${moneyBR(d.despesasTotal)}</b></div>
        `;
        div.appendChild(el);
      });
    }

    function renderMonthPanel(monthKey, rows){
      document.getElementById('monthLabel').textContent = monthKey;

      const dias = Array.from(new Set((rows||[])
        .filter(r => String(r.tipo).toUpperCase()==='TRABALHO')
        .map(r => normalizeISO(r.data))
        .filter(Boolean)
      )).sort();

      const despesas = (rows||[])
        .filter(r => String(r.tipo).toUpperCase()==='DESPESA')
        .reduce((s, r) => {
          const v = typeof r.valor === 'number' ? r.valor : toNumberBR(String(r.valor||''));
          return s + (isFinite(v) ? v : 0);
        }, 0);

      // lista de dias
      const ul = document.getElementById('diasLista');
      const emptyDias = document.getElementById('diasEmpty');
      ul.innerHTML = '';
      if (dias.length===0){
        emptyDias.classList.remove('hidden');
      } else {
        emptyDias.classList.add('hidden');
        dias.forEach(iso=>{
          const li = document.createElement('li');
          li.textContent = fmtDDMMYYYY(iso);
          ul.appendChild(li);
        });
      }

      // tabela
      const tbody = document.getElementById('tbodyMes');
      const tblEmpty = document.getElementById('tblEmpty');
      tbody.innerHTML = '';
      if (!rows || rows.length===0){
        tblEmpty.classList.remove('hidden');
      } else {
        tblEmpty.classList.add('hidden');
        rows
          .slice()
          .sort((a,b)=> normalizeISO(a.data).localeCompare(normalizeISO(b.data)))
          .forEach(r=>{
            const pagoBadge =
              (String(r.pago).toLowerCase()==='sim')
                ? '<span class="badge badge-green">Sim</span>'
                : (String(r.pago).toLowerCase()==='n√£o' || String(r.pago).toLowerCase()==='nao')
                  ? '<span class="badge badge-red">N√£o</span>'
                  : `<span class="badge badge-slate">${(r.pago||'-')}</span>`;

            const tipoBadge =
              (String(r.tipo).toUpperCase()==='DESPESA')
                ? '<span class="badge badge-blue">Despesa</span>'
                : '<span class="badge badge-slate">Trabalho</span>';

            const tr = document.createElement('tr');
            tr.className = 'odd:bg-white even:bg-slate-50';
            tr.innerHTML = `
              <td class="p-2 border">${fmtDDMMYYYY(r.data)}</td>
              <td class="p-2 border">${(r.cliente||'').toString().trim() || '-'}</td>
              <td class="p-2 border">${(r.endereco||'').toString().trim() || '-'}</td>
              <td class="p-2 border">${pagoBadge}</td>
              <td class="p-2 border">${tipoBadge}</td>
              <td class="p-2 border text-right">${
                (() => {
                  const v = typeof r.valor === 'number' ? r.valor : toNumberBR(String(r.valor||''));
                  return v > 0 ? 'R$ ' + moneyBR(v) : '-';
                })()
              }</td>
            `;
            tbody.appendChild(tr);
          });
      }

      // totais
      document.getElementById('despesasTotalMes').textContent = 'R$ ' + moneyBR(despesas);
      document.getElementById('diasCount').textContent = dias.length;
      document.getElementById('despesasCount').textContent = 'R$ ' + moneyBR(despesas);
    }

    /* ===== Fluxo ===== */
    async function loadSummary(){
      const win = document.getElementById('windowSel').value || 6;
      const j = await apiGet('window='+encodeURIComponent(win));
      if (j && j.ok) renderSummary(j.summary||{});
    }
    async function loadMonth(monthKey){
      const k = await apiGet('month='+encodeURIComponent(monthKey));
      if (k && k.ok) renderMonthPanel(monthKey, k.data||[]);
    }
    async function initialLoad(){
      await loadSummary();
      await loadMonth( yyyymm(new Date()) );
    }

    document.getElementById('windowSel').addEventListener('change', loadSummary);
    document.getElementById('btnReload').addEventListener('click', (e)=>{ e.preventDefault(); initialLoad(); });

    // SALVAR
    document.getElementById('newForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!API_URL){ alert('Defina window.GRANTOP_CONFIG.API_URL no config.js'); return; }
      const btn = e.target.querySelector('button[type="submit"]');
      const old = btn.textContent;
      btn.disabled = true; btn.textContent = 'Salvando...';
      try{
        const data = document.getElementById('inData').value;
        const cliente = (document.getElementById('inCliente').value || '').trim();
        const endereco = (document.getElementById('inEndereco').value || '').trim();
        const pago = (document.getElementById('inPago').value || '').trim();
        const valorNum = toNumberBR(document.getElementById('inValor').value);

        const payload = { data, cliente, endereco, pago, descricao:'', valor: valorNum };

        await apiAdd(payload);
        alert('Registro salvo com sucesso!');

        e.target.reset();
        const monthKey = (data && data.length>=7) ? data.slice(0,7) : yyyymm(new Date());
        await loadSummary();
        await loadMonth(monthKey);

      } catch(err){
        console.error(err);
        alert('Falha ao salvar: ' + (err && err.message ? err.message : err));
      } finally {
        btn.disabled = false; btn.textContent = old;
      }
    });

    initialLoad();
  </script>
</body>
</html>
"""

code_gs = r"""/***** GRANTOP ‚Äì Controle Mensal de Trabalho & Despesas (fix colunas + diagn√≥stico)
 * Planilha: aba "Registros"
 * Colunas: id | created_at | data | tipo | cliente | endereco | pago | descricao | valor | mes |
 *****/

// Se o script estiver VINCULADO √† planilha, deixe vazio ''.
// Se for independente, preencha com o ID da planilha.
const SPREADSHEET_ID = '';

const SHEET_NAME = 'Registros';
const HEADERS = ['id','created_at','data','tipo','cliente','endereco','pago','descricao','valor','mes'];

/** Utilidades **/
function _ss() {
  if (SPREADSHEET_ID) return SpreadsheetApp.openById(SPREADSHEET_ID);
  return SpreadsheetApp.getActive();
}
function _sheet() {
  const ss = _ss();
  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) sh = ss.insertSheet(SHEET_NAME);
  _ensureHeaders(sh);
  return sh;
}
function _ensureHeaders(sh) {
  const rng = sh.getRange(1,1,1,HEADERS.length);
  const existing = (rng.getValues()[0] || []).map(x => String(x||'').trim());
  let needs = false;
  for (let i=0;i<HEADERS.length;i++){
    if (existing[i] !== HEADERS[i]) { needs = true; break; }
  }
  if (needs) { rng.setValues([HEADERS]); sh.setFrozenRows(1); }
}

function _nowIso() { return new Date().toISOString(); }
function _yyyymm(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function _parseDate(v){
  if (v instanceof Date) return v;
  if (!v) return null;
  const s = String(v).trim();
  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) { const [Y,M,D] = s.split('-').map(Number); return new Date(Y,M-1,D); }
  if (/^\\d{2}\\/\\d{2}\\/\\d{4}$/.test(s)) { const [D,M,Y] = s.split('/').map(Number); return new Date(Y,M-1,D); }
  const d = new Date(s); return isNaN(d) ? null : d;
}
function _toNumberBR(v){
  if (typeof v === 'number') return isFinite(v) ? v : 0;
  if (v == null) return 0;
  const s = String(v).trim(); if (!s) return 0;
  const n = Number(s.replace(/\\./g,'').replace(',', '.'));
  return isFinite(n) ? n : 0;
}

function _readAllRows() {
  const sh = _sheet();
  const last = sh.getLastRow();
  if (last < 2) return [];
  const rows = sh.getRange(2,1,last-1,HEADERS.length).getValues();
  return rows.map(r => {
    const obj = {}; HEADERS.forEach((h,i)=>obj[h]=r[i]);
    obj.id = String(obj.id || '').trim();
    obj.created_at = obj.created_at ? new Date(obj.created_at).toISOString() : '';
    obj.data = obj.data instanceof Date ? new Date(obj.data).toISOString().slice(0,10) : String(obj.data||'');
    obj.tipo = String(obj.tipo||'').toUpperCase();
    obj.cliente = String(obj.cliente||'');
    obj.endereco = String(obj.endereco||'');
    obj.pago = String(obj.pago||'');
    obj.descricao = String(obj.descricao||'');
    obj.valor = _toNumberBR(obj.valor);
    obj.mes = String(obj.mes||'') || (function(){ const d = _parseDate(obj.data); return d ? _yyyymm(d) : ''; })();
    return obj;
  });
}
function _writeRow(obj){
  const sh = _sheet();
  const row = [
    String(obj.id||'').trim(),          // id
    obj.created_at || _nowIso(),        // created_at
    _parseDate(obj.data) || '',         // data (Date)
    String(obj.tipo||'').toUpperCase(), // tipo
    String(obj.cliente||''),            // cliente
    String(obj.endereco||''),           // endereco
    String(obj.pago||''),               // pago
    String(obj.descricao||''),          // descricao
    _toNumberBR(obj.valor||0),          // valor
    String(obj.mes||'')                 // mes YYYY-MM
  ];
  sh.appendRow(row);
}
function _findRowById(id){
  const sh = _sheet();
  const last = sh.getLastRow();
  if (last < 2) return null;
  const vals = sh.getRange(2,1,last-1,1).getValues().map(v=>String(v[0]||'').trim());
  const idx = vals.indexOf(String(id));
  return (idx === -1) ? null : { rowNumber: 2 + idx };
}
function _updateRow(rowNumber, newObj){
  const sh = _sheet();
  const current = sh.getRange(rowNumber, 1, 1, HEADERS.length).getValues()[0];
  const rowVals = HEADERS.map((h, idx) => {
    if (h === 'data'){
      if (Object.prototype.hasOwnProperty.call(newObj,'data')) {
        const d = _parseDate(newObj.data); return d || current[idx];
      }
      return current[idx];
    }
    if (h === 'valor'){
      if (Object.prototype.hasOwnProperty.call(newObj,'valor')) {
        return _toNumberBR(newObj.valor);
      }
      return current[idx];
    }
    return (newObj[h] !== undefined ? newObj[h] : current[idx]);
  });
  sh.getRange(rowNumber,1,1,HEADERS.length).setValues([rowVals]);
}
function _deleteRow(rowNumber){ _sheet().deleteRow(rowNumber); }

/** API: GET **/
function doGet(e){
  try{
    const p = e && e.parameter ? e.parameter : {};

    if (String(p.diag||'') === '1'){
      const ss = _ss(), sh = _sheet();
      return _json({
        ok:true,
        mode: SPREADSHEET_ID ? 'byId' : 'bound',
        spreadsheetId: ss.getId(),
        spreadsheetUrl: ss.getUrl(),
        activeSheet: sh.getName(),
        sheets: ss.getSheets().map(s=>s.getName())
      });
    }

    const monthFilter = p.month;
    const nRaw = parseInt(p.window, 10);
    const monthsWindow = Number.isFinite(nRaw) && nRaw > 0 ? Math.min(24, nRaw) : 12;

    const all = _readAllRows();
    const data = monthFilter ? all.filter(r => r.mes === monthFilter) : all;
    const summary = _buildMonthlySummary(all, monthsWindow);

    return _json({ ok:true, data, summary, monthsWindow });
  } catch(err){
    return _json({ ok:false, error: String(err) }, 500);
  }
}

/** API: POST **/
function doPost(e){
  try{
    const body = e && e.postData && e.postData.contents ? e.postData.contents : '{}';
    const parsed = JSON.parse(body || '{}');
    const action = parsed && parsed.action;
    const payload = parsed && parsed.payload;

    if (action === 'add'){
      const created_at = _nowIso();
      const id = 'R' + Date.now();

      const d = _parseDate(payload && payload.data) || new Date();
      const mes = _yyyymm(d);
      const valorNum = _toNumberBR(payload && payload.valor);

      let tipo = String(payload && payload.tipo || '').toUpperCase().trim();
      if (!tipo) tipo = valorNum > 0 ? 'DESPESA' : 'TRABALHO';

      const obj = {
        id, created_at, data: d, tipo,
        cliente: (payload && payload.cliente) || '',
        endereco: (payload && payload.endereco) || '',
        pago: (payload && payload.pago) || '',
        descricao: (payload && payload.descricao) || '',
        valor: (tipo === 'DESPESA') ? valorNum : 0,
        mes
      };

      _writeRow(obj);
      return _json({ ok:true, id });

    } else if (action === 'update'){
      if (!payload || !payload.id) throw new Error('Faltou "id" no update');
      const found = _findRowById(payload.id);
      if (!found) throw new Error('Registro n√£o encontrado');

      const newObj = Object.assign({}, payload);
      if (Object.prototype.hasOwnProperty.call(newObj,'valor')) newObj.valor = _toNumberBR(newObj.valor);
      if (newObj.data){ const d = _parseDate(newObj.data); if (d) newObj.mes = _yyyymm(d); }

      _updateRow(found.rowNumber, newObj);
      return _json({ ok:true, id: payload.id });

    } else if (action === 'delete'){
      if (!payload || !payload.id) throw new Error('Faltou "id" no delete');
      const found = _findRowById(payload.id);
      if (!found) throw new Error('Registro n√£o encontrado');
      _deleteRow(found.rowNumber);
      return _json({ ok:true, id: payload.id });

    } else {
      return _json({ ok:false, error:'A√ß√£o inv√°lida. Use add/update/delete.' }, 400);
    }
  } catch(err){
    return _json({ ok:false, error: String(err) }, 500);
  }
}

/** Resumo mensal **/
function _buildMonthlySummary(allRows, monthsWindow){
  const map = {};
  const cutoffSet = new Set(_lastNMonthsKeys(monthsWindow));
  for (const r of allRows){
    const key = r.mes || (function(){ const d = _parseDate(r.data); return d ? _yyyymm(d) : ''; })();
    if (!key || !cutoffSet.has(key)) continue;
    if (!map[key]) map[key] = { diasSet: new Set(), despesasTotal: 0 };
    if (String(r.tipo).toUpperCase() === 'TRABALHO'){
      const d = _parseDate(r.data);
      if (d) map[key].diasSet.add(d.toDateString());
    } else if (String(r.tipo).toUpperCase() === 'DESPESA'){
      map[key].despesasTotal += _toNumberBR(r.valor||0);
    }
  }
  const out = {};
  for (const key of Array.from(cutoffSet).sort()){
    const bucket = map[key] || { diasSet: new Set(), despesasTotal: 0 };
    out[key] = { diasTrabalhados: bucket.diasSet.size, despesasTotal: Number(bucket.despesasTotal.toFixed(2)) };
  }
  return out;
}
function _lastNMonthsKeys(n){
  const now = new Date(); const keys=[];
  for (let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); keys.push(_yyyymm(d)); }
  return keys;
}

/** Helper JSON **/
function _json(obj, status){
  const out = ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
  if (status) { try { out.setStatusCode(status); } catch(_){} }
  return out;
}
"""

import os, zipfile

base_dir = "/mnt/data/grantop_pkg2"
os.makedirs(base_dir, exist_ok=True)

html_path = os.path.join(base_dir, "index.html")
gs_path = os.path.join(base_dir, "Code.gs")

with open(html_path, "w", encoding="utf-8") as f:
    f.write(index_html)

with open(gs_path, "w", encoding="utf-8") as f:
    f.write(code_gs)

zip_path = "/mnt/data/grantop_controle_final_v2.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as z:
    z.write(html_path, arcname="index.html")
    z.write(gs_path, arcname="Code.gs")

zip_path
