<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRANTOP ‚Äì Controle de Trabalho & Despesas</title>
  <link rel="icon" href="data:," />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* URL do seu Apps Script (Web App) */
    var API_URL = 'https://script.google.com/macros/s/AKfycbwWyI0Rsyz4R-aw5dwKKETUOZq_wMSekBIXU3Q-hv-Hcf6-nKxrAgA_aTE20StEoWUq/exec';
  </script>
  <style>
    .card{border:1px solid #e2e8f0;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .badge{border-radius:9999px;padding:2px 8px;font-size:12px;font-weight:600;display:inline-block}
    .badge-green{background:#dcfce7;color:#166534}.badge-red{background:#fee2e2;color:#991b1b}
    .badge-blue{background:#dbeafe;color:#1e40af}.badge-slate{background:#e2e8f0;color:#334155}
    .btn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid #cbd5e1;border-radius:8px;padding:.35rem .6rem;font-size:.8rem;background:#fff}
    .btn:hover{background:#f8fafc}
    .clickable{cursor:pointer}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="p-4 bg-white shadow flex items-center justify-between">
    <h1 class="text-lg md:text-xl font-bold">üìä Controle Mensal ‚Äì GRANTOP</h1>
    <div class="flex items-center gap-3">
      <label class="text-sm flex items-center gap-2">M√™s:
        <select id="monthSel" class="border rounded px-2 py-1"></select>
      </label>
      <a href="#" id="btnReload" class="text-sm text-blue-700 hover:underline">Atualizar</a>
    </div>
  </header>

  <main class="p-4 space-y-6">

    <!-- FORM -->
    <section class="card p-4">
      <h2 class="font-semibold mb-3">Adicionar Registro</h2>
      <form id="newForm" class="grid md:grid-cols-7 gap-3">
        <input id="inData" class="border rounded px-3 py-2" name="data" type="date" required />
        <input id="inCliente" class="border rounded px-3 py-2" name="cliente" placeholder="Cliente" />
        <input id="inEndereco" class="border rounded px-3 py-2 md:col-span-2" name="endereco" placeholder="Endere√ßo" />
        <select id="inTipo" class="border rounded px-3 py-2" name="tipo">
          <option value="TRABALHO" selected>TRABALHO</option>
          <option value="DESPESA">DESPESA</option>
        </select>
        <select id="inPago" class="border rounded px-3 py-2" name="pago">
          <option value="">Pago? ‚Äî</option>
          <option value="N√£o">N√£o</option>
          <option value="Sim">Sim</option>
        </select>
        <input id="inValor" class="border rounded px-3 py-2" name="valor" type="text" inputmode="decimal" placeholder="Valor (DESPESA)" />
        <button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 md:col-span-7" type="submit">Salvar</button>
      </form>
      <p class="text-xs text-slate-500 mt-2">Obs.: TRABALHO ignora o valor; DESPESA exige valor. ‚ÄúDias trabalhados‚Äù contam datas √∫nicas com tipo ‚ÄúTRABALHO‚Äù.</p>
    </section>

    <!-- RESUMO (1..6 meses terminando no m√™s selecionado) -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Resumo Mensal</h2>
        <div class="flex items-center gap-3">
          <label class="text-sm flex items-center gap-2">√öltimos:
            <select id="winSel" class="border rounded px-2 py-1">
              <option value="1" selected>1 m√™s</option>
              <option value="2">2 meses</option>
              <option value="3">3 meses</option>
              <option value="4">4 meses</option>
              <option value="5">5 meses</option>
              <option value="6">6 meses</option>
            </select>
          </label>
          <div id="summaryLoading" class="text-xs text-slate-500 hidden">Carregando...</div>
        </div>
      </div>
      <div id="summary" class="grid md:grid-cols-3 gap-3"></div>
    </section>

    <!-- M√äS -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="font-semibold">Registros do m√™s</h2>
          <div class="text-sm">Selecionado: <b id="monthLabel"></b></div>
        </div>
        <div id="diasHeader" class="text-xl font-extrabold text-slate-800"></div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-4">
        <div class="p-3 rounded-xl border bg-white">
          <div class="font-semibold mb-1">Dias trabalhados (lista)</div>
          <ul id="diasLista" class="list-disc pl-5 text-sm space-y-1"></ul>
          <div id="diasEmpty" class="text-xs text-slate-500 hidden">N√£o h√° dias trabalhados registrados para este m√™s.</div>
        </div>
        <div class="p-3 rounded-xl border bg-white">
          <div class="font-semibold mb-1">Total de despesas no m√™s</div>
          <div id="despesasTotalMes" class="text-lg font-bold">R$ 0,00</div>
        </div>
        <div class="p-3 rounded-xl border bg-white">
          <div class="font-semibold mb-1">Somat√≥ria do m√™s</div>
          <div class="text-sm">
            Dias trabalhados: <b id="diasCount">0</b><br/>
            Despesas: <b id="despesasCount">R$ 0,00</b>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border rounded-lg overflow-hidden">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2 border">Data</th>
              <th class="text-left p-2 border">Cliente</th>
              <th class="text-left p-2 border">Endere√ßo</th>
              <th class="text-left p-2 border">Pago</th>
              <th class="text-left p-2 border">Tipo</th>
              <th class="text-right p-2 border">Valor</th>
              <th class="text-left p-2 border">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbodyMes"></tbody>
        </table>
        <div id="tblEmpty" class="text-xs text-slate-500 mt-2 hidden">N√£o h√° registros para este m√™s.</div>
      </div>
    </section>
  </main>

  <!-- Modal de Edi√ß√£o -->
  <dialog id="editDlg" class="rounded-xl p-0 border w-[95%] md:w-[560px]">
    <form method="dialog" id="editForm" class="p-4 space-y-3">
      <div class="text-lg font-semibold">Editar Registro</div>
      <input type="hidden" id="edId" />
      <div class="grid md:grid-cols-2 gap-3">
        <label class="text-sm">Data
          <input id="edData" class="border rounded px-3 py-2 w-full" type="date" required />
        </label>
        <label class="text-sm">Tipo
          <select id="edTipo" class="border rounded px-3 py-2 w-full">
            <option>TRABALHO</option>
            <option>DESPESA</option>
          </select>
        </label>
        <label class="text-sm md:col-span-2">Cliente
          <input id="edCliente" class="border rounded px-3 py-2 w-full" />
        </label>
        <label class="text-sm md:col-span-2">Endere√ßo
          <input id="edEndereco" class="border rounded px-3 py-2 w-full" />
        </label>
        <label class="text-sm">Pago
          <select id="edPago" class="border rounded px-3 py-2 w-full">
            <option value="">‚Äî</option>
            <option>N√£o</option>
            <option>Sim</option>
          </select>
        </label>
        <label class="text-sm">Valor (DESPESA)
          <input id="edValor" class="border rounded px-3 py-2 w-full" inputmode="decimal" />
        </label>
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button class="btn" value="cancel">Cancelar</button>
        <button id="btnSaveEdit" class="btn">Salvar altera√ß√µes</button>
      </div>
    </form>
  </dialog>

  <script>
    /* ===== Utils ===== */
    const moneyBR = v => Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    const toNumberBR = v => !v ? 0 : Number(String(v).replace(/\./g,'').replace(',', '.')) || 0;
    const yyyymm = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    const thisMonthKey = ()=> yyyymm(new Date());

    function normalizeISO(dateLike){
      if (!dateLike) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(String(dateLike))) return String(dateLike);
      const d = new Date(String(dateLike));
      if (isNaN(d)) return '';
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }
    function fmtDDMMYYYY(iso){
      const s = normalizeISO(iso);
      if (!s) return '';
      const [Y,M,D] = s.split('-');
      return `${D}/${M}/${Y}`;
    }
    function keyFromDateLike(x){
      if (!x) return '';
      if (/^\d{4}-\d{2}$/.test(String(x))) return String(x);
      const d = new Date(String(x));
      return isNaN(d) ? '' : yyyymm(d);
    }

    /* ===== JSONP helper ===== */
    function jsonp(url, timeout=15000){
      return new Promise((resolve, reject)=>{
        const cbName = '__grantop_cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        let done = false;
        const clear = ()=>{ if (done) return; done = true; delete window[cbName]; s.remove(); };
        const timer = setTimeout(()=>{ clear(); reject(new Error('timeout')); }, timeout);
        window[cbName] = (data)=>{ clearTimeout(timer); clear(); resolve(data); };
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName + '&_=' + Date.now();
        s.onerror = ()=>{ clearTimeout(timer); clear(); reject(new Error('network error')); };
        document.body.appendChild(s);
      });
    }

    /* ===== API ===== */
    const apiGet = async (params='')=>{
      const url = API_URL + (params?`?${params}`:'');
      const load = document.getElementById('summaryLoading');
      load.classList.remove('hidden');
      try{
        const j = await jsonp(url);
        if (!j || j.ok !== true) throw new Error('GET falhou');
        return j;
      } finally {
        load.classList.add('hidden');
      }
    };
    const apiAdd = async (payload)=>{
      const url = API_URL + '?action=add&payload=' + encodeURIComponent(JSON.stringify(payload));
      const j = await jsonp(url);
      if (!j || !j.ok) throw new Error((j && j.error) || 'Falha no add');
      return j;
    };
    const apiUpdate = async (payload)=>{
      const url = API_URL + '?action=update&payload=' + encodeURIComponent(JSON.stringify(payload));
      const j = await jsonp(url);
      if (!j || !j.ok) throw new Error((j && j.error) || 'Falha no update');
      return j;
    };
    const apiDelete = async (id)=>{
      const url = API_URL + '?action=delete&payload=' + encodeURIComponent(JSON.stringify({ id }));
      const j = await jsonp(url);
      if (!j || !j.ok) throw new Error((j && j.error) || 'Falha no delete');
      return j;
    };

    /* ===== Render ===== */
    function renderSummaryWindow(summary, selectedKey, n){
      const div = document.getElementById('summary');
      div.innerHTML = '';
      const keys = Object.keys(summary||{}).sort();
      const idx = Math.max(0, keys.indexOf(selectedKey));
      const start = Math.max(0, idx - (n-1));
      const slice = keys.slice(start, idx+1);
      slice.forEach(k=>{
        const d = summary[k] || {diasTrabalhados:0, despesasTotal:0};
        const el = document.createElement('div');
        el.className = 'p-3 rounded-xl border shadow text-sm bg-white';
        el.innerHTML = `
          <div class="font-semibold">${k}</div>
          <div>Dias trabalhados: <b>${d.diasTrabalhados}</b></div>
          <div>Despesas: R$ <b>${moneyBR(d.despesasTotal)}</b></div>
        `;
        div.appendChild(el);
      });
    }

    function pagoBadgeHTML(pago){
      const val = (String(pago||'').toLowerCase());
      if (val==='sim'){
        return '<span class="badge badge-green clickable js-toggle-pago" data-next="N√£o">Sim</span>';
      } else if (val==='n√£o' || val==='nao'){
        return '<span class="badge badge-red clickable js-toggle-pago" data-next="Sim">N√£o</span>';
      } else {
        return '<span class="badge badge-slate clickable js-toggle-pago" data-next="Sim">‚Äî</span>';
      }
    }

    function renderMonthPanel(monthKey, rows){
      document.getElementById('monthLabel').textContent = monthKey;

      const dias = Array.from(new Set((rows||[])
        .filter(r => String(r.tipo).toUpperCase()==='TRABALHO')
        .map(r => normalizeISO(r.data))
        .filter(Boolean)
      )).sort();

      const despesas = (rows||[])
        .filter(r => String(r.tipo).toUpperCase()==='DESPESA')
        .reduce((s, r) => {
          const v = typeof r.valor === 'number' ? r.valor : toNumberBR(String(r.valor||''));
          return s + (isFinite(v) ? v : 0);
        }, 0);

      // Header grande dos dias trabalhados
      const diasHeader = document.getElementById('diasHeader');
      diasHeader.textContent = `${dias.length} ${dias.length===1?'DIA':'DIAS'} TRABALHADO${dias.length===1?'':'S'}`;

      // lista de dias
      const ul = document.getElementById('diasLista');
      const emptyDias = document.getElementById('diasEmpty');
      ul.innerHTML = '';
      if (dias.length===0){
        emptyDias.classList.remove('hidden');
      } else {
        emptyDias.classList.add('hidden');
        dias.forEach(iso=>{
          const li = document.createElement('li');
          li.textContent = fmtDDMMYYYY(iso);
          ul.appendChild(li);
        });
      }

      // tabela
      const tbody = document.getElementById('tbodyMes');
      const tblEmpty = document.getElementById('tblEmpty');
      tbody.innerHTML = '';
      if (!rows || rows.length===0){
        tblEmpty.classList.remove('hidden');
      } else {
        tblEmpty.classList.add('hidden');
        rows
          .slice()
          .sort((a,b)=> normalizeISO(a.data).localeCompare(normalizeISO(b.data)))
          .forEach(r=>{
            const tipoBadge =
              (String(r.tipo).toUpperCase()==='DESPESA')
                ? '<span class="badge badge-blue">Despesa</span>'
                : '<span class="badge badge-slate">Trabalho</span>';

            const vnum = typeof r.valor === 'number' ? r.valor : toNumberBR(String(r.valor||''));

            const tr = document.createElement('tr');
            tr.className = 'odd:bg-white even:bg-slate-50';
            tr.innerHTML = `
              <td class="p-2 border">${fmtDDMMYYYY(r.data)}</td>
              <td class="p-2 border">${(r.cliente||'').toString().trim() || '-'}</td>
              <td class="p-2 border">${(r.endereco||'').toString().trim() || '-'}</td>
              <td class="p-2 border" data-id="${r.id}">${pagoBadgeHTML(r.pago)}</td>
              <td class="p-2 border">${tipoBadge}</td>
              <td class="p-2 border text-right">${vnum > 0 ? 'R$ ' + moneyBR(vnum) : '-'}</td>
              <td class="p-2 border">
                <button class="btn js-edit" data-id="${r.id}">Editar</button>
                <button class="btn js-del" data-id="${r.id}">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

        // listeners (delega√ß√£o)
        tbody.addEventListener('click', async (ev)=>{
          const t = ev.target;
          if (t.matches('.js-edit')){
            const id = t.dataset.id;
            openEdit(id, rows);
          }
          if (t.matches('.js-del')){
            const id = t.dataset.id;
            if (confirm('Confirma excluir este registro?')){
              await apiDelete(id);
              await reloadAll();
            }
          }
          if (t.matches('.js-toggle-pago')){
            const td = t.closest('td');
            const id = td.getAttribute('data-id');
            const next = t.getAttribute('data-next') || 'Sim';
            await apiUpdate({ id, pago: next });
            await reloadAll();
          }
        }, { once:true });
      }

      // totais
      document.getElementById('despesasTotalMes').textContent = 'R$ ' + moneyBR(despesas);
      document.getElementById('diasCount').textContent = dias.length;
      document.getElementById('despesasCount').textContent = 'R$ ' + moneyBR(despesas);
    }

    /* ===== Edit modal ===== */
    function openEdit(id, rows){
      const it = (rows||[]).find(x=> String(x.id)===String(id));
      if (!it) return;
      document.getElementById('edId').value = it.id || '';
      document.getElementById('edData').value = normalizeISO(it.data);
      document.getElementById('edTipo').value = (String(it.tipo||'TRABALHO').toUpperCase());
      document.getElementById('edCliente').value = it.cliente || '';
      document.getElementById('edEndereco').value = it.endereco || '';
      document.getElementById('edPago').value = (it.pago || '');
      document.getElementById('edValor').value = (typeof it.valor==='number' ? it.valor.toFixed(2) : String(it.valor||''));

      const dlg = document.getElementById('editDlg');
      if (!dlg.open) dlg.showModal();

      document.getElementById('btnSaveEdit').onclick = async (ev)=>{
        ev.preventDefault();
        const id = document.getElementById('edId').value;
        const data = document.getElementById('edData').value;
        const tipo = document.getElementById('edTipo').value;
        const cliente = document.getElementById('edCliente').value;
        const endereco = document.getElementById('edEndereco').value;
        const pago = document.getElementById('edPago').value;
        const valorNum = toNumberBR(document.getElementById('edValor').value);
        const payload = { id, data, tipo, cliente, endereco, pago, valor: (tipo==='DESPESA'?valorNum:0) };
        await apiUpdate(payload);
        dlg.close();
        await reloadAll();
      };
    }

    /* ===== Fluxo ===== */
    let cachedSummary = {};
    let cachedAllRows = [];

    function fillMonthSelector(keys, selected){
      const sel = document.getElementById('monthSel');
      sel.innerHTML = '';
      keys.forEach(k=>{
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = k;
        if (k===selected) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function rerenderFromSelectors(){
      const selectedKey = document.getElementById('monthSel').value;
      const n = parseInt(document.getElementById('winSel').value, 10) || 1;
      renderSummaryWindow(cachedSummary, selectedKey, n);
      const rows = cachedAllRows.filter(r => (keyFromDateLike(r.mes) || keyFromDateLike(r.data)) === selectedKey);
      renderMonthPanel(selectedKey, rows);
      document.getElementById('monthLabel').textContent = selectedKey;
    }

    async function reloadAll(){
      // Resumo (carrega 12 meses)
      const summaryResp = await apiGet('window=12');
      cachedSummary = summaryResp.summary || {};

      // Chave padr√£o = m√™s atual (ou √∫ltimo do summary)
      const keys = Object.keys(cachedSummary).sort();
      let selectedKey = keys.includes(thisMonthKey()) ? thisMonthKey() : (keys.length ? keys[keys.length-1] : thisMonthKey());
      fillMonthSelector(keys, selectedKey);

      // Dados
      const dataResp = await apiGet('');
      cachedAllRows = (dataResp && dataResp.ok && Array.isArray(dataResp.data)) ? dataResp.data : [];

      rerenderFromSelectors();
    }

    document.getElementById('monthSel').addEventListener('change', rerenderFromSelectors);
    document.getElementById('winSel').addEventListener('change', rerenderFromSelectors);
    document.getElementById('btnReload').addEventListener('click', (e)=>{ e.preventDefault(); reloadAll(); });

    // Tipo => habilitar/validar valor/pago
    function refreshTipoUI(){
      const tipo = document.getElementById('inTipo').value;
      const valor = document.getElementById('inValor');
      const pago = document.getElementById('inPago');
      if (tipo === 'DESPESA'){
        valor.disabled = false;
      } else {
        valor.disabled = true;
        valor.value = '';
        if (pago.value==='Sim') pago.value='';
      }
    }
    document.getElementById('inTipo').addEventListener('change', refreshTipoUI);
    refreshTipoUI();

    // SALVAR
    document.getElementById('newForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const old = btn.textContent;
      btn.disabled = true; btn.textContent = 'Salvando...';
      try{
        const data = document.getElementById('inData').value;
        const cliente = (document.getElementById('inCliente').value || '').trim();
        const endereco = (document.getElementById('inEndereco').value || '').trim();
        const tipo = document.getElementById('inTipo').value;
        const pago = (document.getElementById('inPago').value || '').trim();
        const valorNum = toNumberBR(document.getElementById('inValor').value);

        if (tipo==='DESPESA' && !(valorNum>0)) {
          alert('Para DESPESA, informe um valor.');
          return;
        }

        const payload = { data, cliente, endereco, tipo, pago, descricao:'', valor: (tipo==='DESPESA' ? valorNum : 0) };

        await apiAdd(payload);
        alert('Registro salvo com sucesso!');

        e.target.reset();
        refreshTipoUI();
        await reloadAll();

      } catch(err){
        console.error(err);
        alert('Falha ao salvar: ' + (err && err.message ? err.message : err));
      } finally {
        btn.disabled = false; btn.textContent = old;
      }
    });

    // Inicial
    reloadAll();
  </script>
</body>
</html>
